#!/sbin/sh -x
# amonet updater
# Copyright (C) 2019 k4y0z @ xda-developers

PAYLOAD_BLOCK=1024

PART_PREFIX=/dev/block/platform/soc/11230000.mmc

# detect whether in boot mode
getprop | grep zygote | grep -q running && bootMode=true || bootMode=false

# Default permissions
umask 022

##########################################################################################
# Functions
##########################################################################################

ui_print() {
  $bootMode && echo -e "$1" || echo -e "ui_print $1\nui_print" >> /proc/self/fd/$outFD
}

# not a function, but must be here
if $bootMode; then
  ui_print " "
  ui_print "(!) Boot mode install is not supported"
  ui_print "- Install from recovery mode"
  ui_print " "
  exit 1
fi

grep_prop() {
  REGEX="s/^$1=//p"
  shift
  FILES=$@
  [ -z "$FILES" ] && FILES='/default.prop'
  sed -n "$REGEX" $FILES 2>/dev/null | head -n 1
}

check_product() {
  product=$(grep_prop ro.product.device)

  if [ "$product" != "${1}" ] ; then
    ui_print "This is only for the \"${1}\"${2}, your device is a \"${product}\""
    exit 1
  fi
}

##########################################################################################
# Flashable update-binary preparation
##########################################################################################

# set SELinux mode to "permissive"
setenforce 0

outFD=$2
ZIP="$3"

readlink /proc/$$/fd/$outFD 2>/dev/null | grep /tmp >/dev/null
if [ "$?" -eq "0" ]; then
  outFD=0

  for FD in `ls /proc/$$/fd`; do
  readlink /proc/$$/fd/$FD 2>/dev/null | grep pipe >/dev/null
  if [ "$?" -eq "0" ]; then
    ps | grep " 3 $FD " | grep -v grep >/dev/null
    if [ "$?" -eq "0" ]; then
    outFD=$FD
    break
    fi
  fi
  done
fi

check_product "karnak" " - Amazon Fire HD 8 (2018 / 8th gen) - "

TMPDIR=/dev/tmp
INSTALLER=$TMPDIR/install

# initial cleanup
rm -rf $TMPDIR 2>/dev/null
mkdir -p $INSTALLER 2>/dev/null

unzip -o "$ZIP" 'amonet/bin/twrp.img' 'amonet/lk-payload/build/payload.bin' 'amonet/bin/preloader.hdr0', 'amonet/bin/preloader.hdr1', 'amonet/bin/preloader.bin', 'amonet/bin/tz.img' 'amonet/bin/boot0.gpt' -d $INSTALLER >&2

##########################################################################################
# Main
##########################################################################################

ui_print " "
ui_print "amonet updater"

ui_print "- updating TWRP"
dd if=${INSTALLER}/amonet/bin/twrp.img of=${PART_PREFIX}/by-name/recovery

dd if=${PART_PREFIX}/by-name/recovery of=/tmp/recovery_amonet.hdr bs=512 count=2
dd if=${PART_PREFIX}/by-name/boot of=/tmp/boot_amonet.hdr bs=512 count=2
dd if=${PART_PREFIX}/by-name/boot of=/tmp/boot_amonet.hdr2 bs=512 count=2 skip=2
grep "ANDROID!" /tmp/boot_amonet.hdr2
if [ $? -ne 0 ] ; then
    ui_print "- patching boot"
    dd if=/tmp/boot_amonet.hdr of=${PART_PREFIX}/by-name/boot bs=512 count=2 seek=2
fi
ui_print "- updating microloader"
dd if=${INSTALLER}/amonet/bin/twrp.img of=${PART_PREFIX}/by-name/boot bs=512 count=2

echo 0 > /sys/block/mmcblk0boot0/force_ro

#ui_print "- updating preloader"
#dd if=/${INSTALLER}/amonet/bin/preloader.hdr0 of=/dev/block/mmcblk0boot0 bs=512 count=4
#dd if=/${INSTALLER}/amonet/bin/preloader.hdr1 of=/dev/block/mmcblk0boot0 bs=512 seek=4 count=4
#dd if=/${INSTALLER}/amonet/bin/preloader.bin of=/dev/block/mmcblk0boot0 bs=512 seek=8

ui_print "- updating backup PL"
dd if=/${INSTALLER}/amonet/bin/preloader.bin of=/dev/block/mmcblk0boot0 bs=512 seek=520 count=504

ui_print "- checking for GPT on boot0"
if [[ ! $(dd if=/dev/block/mmcblk0boot0 bs=512 skip=2047 | grep "EFI PART" ) ]]; then
  ui_print "-- no GPT found, likely nuked by following previous advice to brick preloader"
  ui_print "-- restoring GPT"
  dd if=/${INSTALLER}/amonet/bin/boot0.gpt of=/dev/block/mmcblk0boot0 bs=512 seek=2015
else
  ui_print "-- GPT present, all good"
fi

ui_print "- updating payload"
dd if=/${INSTALLER}/amonet/lk-payload/build/payload.bin of=/dev/block/mmcblk0boot0 bs=512 seek=${PAYLOAD_BLOCK}

echo 1 > /sys/block/mmcblk0boot0/force_ro

#ui_print "- updating TEE1"
#dd if=/${INSTALLER}/amonet/bin/tz.img of=${PART_PREFIX}/by-name/TEE1_real

#ui_print "- updating TEE2"
#dd if=/${INSTALLER}/amonet/bin/tz.img of=${PART_PREFIX}/by-name/TEE2_real

ui_print "- Update complete"
ui_print " "

exit 0
